<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Save and Edit - Digital Signature</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f9f9f9;
        color: #333;
      }

      h1 {
        text-align: center;
        color: #0056b3;
        margin-bottom: 20px;
      }

      #form-container {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        max-width: 600px;
        margin: 0 auto;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 30px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      label {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 10px;
      }

      textarea {
        width: 100%;
        height: 150px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 4px;
        resize: none;
        background-color: #f9f9f9;
        margin-bottom: 20px;
      }

      textarea:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
      }

      .buttons {
        display: flex;
        gap: 15px;
      }

      button {
        padding: 12px 20px;
        font-size: 16px;
        font-weight: bold;
        color: #fff;
        background-color: #007bff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      button#resetBtn {
        background-color: #dc3545;
      }

      button:hover {
        background-color: #0056b3;
      }

      button#resetBtn:hover {
        background-color: #c82333;
      }

      #saved-messages {
        margin-top: 30px;
        padding: 25px;
        border: 1px solid #ccc;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      #saved-messages ul {
        list-style-type: none;
        padding: 0;
        margin: 0;
      }

      #saved-messages li {
        padding: 12px 0;
        font-size: 18px;
        border-bottom: 1px solid #eee;
      }

      #saved-messages li:last-child {
        border-bottom: none;
      }
    </style>
  </head>
  <body>
    <h1>Save and Edit</h1>
    <div id="form-container">
      <form id="messageForm">
        <label for="message">Message:</label>
        <textarea
          id="message"
          name="message"
          rows="6"
          cols="50"
          placeholder="Enter your message here"
          required
        ></textarea>
        <div class="buttons">
          <button type="submit" id="saveBtn">Save</button>
          <button type="reset" id="resetBtn">Reset</button>
        </div>
      </form>
    </div>
    <div id="saved-messages">
      <h2>Saved Messages</h2>
      <ul id="messageList">
        <li>Loading messages...</li>
      </ul>
    </div>
    <script>
      // Fetch saved messages from the server
      async function loadSavedMessages() {
        const messageList = document.getElementById("messageList");
        messageList.innerHTML = "<li>Loading messages...</li>"; // Show loading

        try {
          const response = await fetch("/load-saved-messages");
          if (response.ok) {
            const messages = await response.json();
            messageList.innerHTML = ""; // Clear existing list

            if (messages.length > 0) {
              messages.forEach((msg) => {
                const li = document.createElement("li");
                li.textContent = msg.msg_content;
                li.dataset.msgId = msg.msg_id;

                const editButton = document.createElement("button");
                editButton.textContent = "Edit";
                editButton.style.marginLeft = "10px";
                editButton.addEventListener("click", () =>
                  editMessage(msg.msg_id, msg.msg_content)
                );

                li.appendChild(editButton);
                messageList.appendChild(li);
              });
            } else {
              messageList.innerHTML = "<li>No saved messages yet.</li>";
            }
          } else {
            console.error("Failed to load messages:", response.statusText);
          }
        } catch (error) {
          console.error("Error fetching messages:", error);
          messageList.innerHTML = "<li>Failed to load messages.</li>";
        }
      }

      function editMessage(msgId, msgContent) {
        // Populate the textarea with the message content
        const messageTextarea = document.getElementById("message");
        messageTextarea.value = msgContent;

        // Store the message ID and original content in the textarea's dataset
        messageTextarea.dataset.msgId = msgId;
        messageTextarea.dataset.original = msgContent; // Store the original content
      }

      document
        .getElementById("messageForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const messageTextarea = document.getElementById("message");
          const message = messageTextarea.value.trim(); // Get the trimmed value
          const originalMessage = messageTextarea.dataset.original || ""; // Get the original value
          const msgId = messageTextarea.dataset.msgId || null; // Check if editing

          // Check if the message is unchanged
          if (msgId && message === originalMessage) {
            alert("No changes were made to the message.");
            return; // Stop the submission
          }

          if (!message) {
            alert("Message cannot be empty!");
            return; // Stop submission if message is empty
          }

          const url = msgId ? `/save-message/${msgId}` : "/save-message"; // Decide endpoint
          const method = msgId ? "PATCH" : "POST"; // Decide method

          try {
            const response = await fetch(url, {
              method: method,
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ message }),
            });

            if (response.ok) {
              alert(
                msgId
                  ? "Message updated successfully!"
                  : "Message saved successfully!"
              );
              messageTextarea.value = ""; // Clear the textarea
              delete messageTextarea.dataset.msgId; // Clear edit mode
              delete messageTextarea.dataset.original; // Clear original value
              loadSavedMessages(); // Reload messages
            } else {
              const error = await response.json();
              alert(
                `Error: ${error.message || "An unexpected error occurred."}`
              );
            }
          } catch (err) {
            console.error("Error saving message:", err);
          }
        });

      // Reset button functionality
      document
        .getElementById("resetBtn")
        .addEventListener("click", function (e) {
          e.preventDefault(); // Prevent default reset behavior

          const messageTextarea = document.getElementById("message");
          messageTextarea.value = ""; // Clear the textarea
          delete messageTextarea.dataset.msgId; // Clear edit mode
        });

      // Load messages when the page is ready
      document.addEventListener("DOMContentLoaded", loadSavedMessages);
    </script>
  </body>
</html>
